<!-- file:///D:/html/fish.html?width=16&height=7&players=4 -->
<!DOCTYPE html>
<html>
    <head>
        <style>        
            *, *::before, *::after {
                margin: 0;
                padding: 0;
                border: 0;
                box-sizing: border-box;
                font-size: 0;
            }

            body {
                background-color: cornflowerblue;

                /* DEBUG */
                /* border-width: 1px; */
                /* border-color: black; */
                /* border-style: solid; */
            }

            .game {
                margin-top: 30px;
                margin-left: 30px;
                margin-bottom: 100px;
            }

            .board {
                text-align: center;
                /*margin-top: 10px;*/
                /* margin-bottom: 100px;*/
                display: inline-block;

                /* DEBUG */
                /* border-width: 1px; */
                /* border-color: black; */
                /* border-style: solid; */
            }

            .row {
                margin-bottom: 24px;
            }

            .cell {
                width: 100px;
                height: 100px;
                text-align: center;
                display: inline-block;
                position: relative;
                margin-left: 21px;
                margin-top: 21px;
            }

            .cell:nth-child(even) {
                top: 72px;
            }

            .hex_tile,
            .hex_img {
                display: inline-block;             
                clip-path: polygon(25% 5%, 75% 5%, 100% 50%, 75% 95%, 25% 95%, 0% 50%);
                top: 50%;
                left: 50%;
                position: absolute;
                transform: translate(-50%, -50%);
            }

            .hex_tile {                
                width: 160%;
                height: 160%;
                background-color:aqua;
            }

            .hex_tile_hidden,
            .hex_tile_hidden > .hex {
                display: none;
            }

            .hex_tile:hover {
                background-color:darkslateblue;
            }

            .hex_tile:active {
                background-color: red;
            }

            .hex_img {
                width: 90%;
                height: 90%;
            }

            .scoreboard {
                margin-left: 60px;
                display: inline-block;
                position: absolute;
                
                /* DEBUG */
                /* border-width: 1px; */
                /* border-color: black; */
                /* border-style: solid; */
            }

            .score {
                font-size: 30px;
                position: relative;
                /* DEBUG */
                /* border-width: 1px; */
                /* border-color: black; */
                /* border-style: solid; */
            }
        </style>
    </head>
    <body>
        <div class="game">
            <div class="board"></div><div class="scoreboard"></div>
        </div>
    </body>
    <script>
        let player_index = 0;

        const params = new URLSearchParams(window.location.search);
        const width = params.get('width');
        const height = params.get('height');
        const nplayers = params.get('players');

        // TBD: Check nplayers;

        class Player {
            constructor(color) {
                this.color = color;
                this.score = 0;
                this.last_selected_tile = null;
            }
        }

        let players = [
            new Player('red'),
            new Player('green'),
            new Player('blue'),
            new Player('yellow')
        ];
    
        setBoard(width, height, nplayers);

        function tileOnClick(e) {
            // Either .hex_tile or .hex_image can be clicked, so to always select the .hex_tile
            // we find the most nested element which is .hex_image and select its parent.
            let element = e.target;

            while (element.firstElementChild) {
                element = element.firstElementChild;
            }
            element = element.parentElement;

            if (selectElementForPlayer(element, player_index)) {
                player_index = (player_index + 1) % nplayers;
            }
        }

        function setBoard(width, height, nplayers) {
            let board = document.querySelector('.board');

            for (j = 0; j < height; ++j) {
                let row = document.createElement('div');
                row.className = 'row';
                for (i = 0; i < width; ++i) {
                    let cell = document.createElement('div');
                    cell.className = 'cell';

                    let hex_tile = document.createElement('div');
                    hex_tile.className = 'hex_tile';
                    hex_tile.id = '_' + j + '_' + i;
                    hex_tile.addEventListener('click', tileOnClick, false);
                
                    let hex_img = document.createElement('img');
                    hex_img.className = 'hex_img';
                    let n = Math.floor(Math.random() * 3) + 1;   
                    hex_img.src = n + 'fish.jpg';

                    hex_tile.appendChild(hex_img);
                    cell.appendChild(hex_tile);
                    row.appendChild(cell);
                }
                board.appendChild(row);
            }

            let scoreboard = document.querySelector('.scoreboard');

            for (k = 0; k < nplayers; ++k) {
                let score = document.createElement('div');
                score.className = 'score';
                score.style.color = players[k].color;
                score.innerHTML = 'Score: 0';
                scoreboard.appendChild(score);
            }
        }

        function allPlayersPositions() {
            let positions = [];
            for (i = 0; i < nplayers; ++i) {
                if (players[i].last_selected_tile != null) {
                    positions.push(yxFromId(players[i].last_selected_tile.id))
                }
            }
            return positions;
        }

        function otherPlayersPositions(x, y) {
            return allPlayersPositions().filter(
                (position) => { return (position[0] != y) || (position[1] != x); }
            );
        }

        function otherPlayersInColumnPositions(x, y) {
            return otherPlayersPositions(x, y).filter(
                (position) => { return (position[1] == x); }
            );
        }

        function otherPlayersInColumnYs(x, y) {
            return otherPlayersInColumnPositions(x, y).map(position => position[0]);
        }

        function columnMinMax(x1, y1) {
            let ymin = y1;
            let ymax = y1;
            let id;
            let hex_tile;
            let other = otherPlayersInColumnYs(x1, y1);

            while (ymin >= 0) {
                id = '#_' + ymin + '_' + x1;
                hex_tile = document.querySelector(id);
                if (hex_tile.style.visibility == 'hidden' ||
                    other.includes(ymin)) {
                    break;
                }
                ymin -= 1;
            }

            while (ymax < height) {
                id = '#_' + ymax + '_' + x1;
                hex_tile = document.querySelector(id);
                if (hex_tile.style.visibility == 'hidden' ||
                    other.includes(ymax)) {
                    break;
                }
                ymax += 1;
            }

            return {ymin, ymax};
        }

        function yxFromId(id) {
            return id.substring(1).split('_').map(x => +x);
        }

        function isValidSelection(hex_tile, player_index) {
            // Do nothing if hex_tile clicked again.
            for (i = 0; i < nplayers; ++i) {
                if (players[i].last_selected_tile == hex_tile) {
                    return false;
                }
            }
            
            if (players[player_index].last_selected_tile != null) {
                let coordinates1 = yxFromId(players[player_index].last_selected_tile.id);
                let y1 = coordinates1[0];
                let x1 = coordinates1[1];

                let coordinates2 = yxFromId(hex_tile.id);
                let y2 = coordinates2[0];
                let x2 = coordinates2[1];

                let dx = Math.abs(x1 - x2);
                let dy = Math.abs(y1 - y2);

                // Elements in the same column.
                let {ymin, ymax} = columnMinMax(x1, y1);
                if ((x1 == x2) && (y2 > ymin) && (y2 < ymax))
                    return true;

                // Elements in adjacent columns in the same row.
                if ((y1 == y2) && (dx == 1))
                    return true;

                // Elements on (x = 2y) or (x = -2y) diagonals.
                if(dx == 2 * dy)
                    return true;

                // Elements on (x = 2y) or (x = -2y) diagonals adjusted with +/- 1 margin
                // depending on previous selection column, if it was even or odd
                // and relation between previous and curren selection row.
                let odd = (x1 % 2) ? 1 : -1;
                let greater = (y1 > y2) ? 1 : -1;
                let margin = odd * greater;

                if(dx == 2 * dy + margin)
                    return true;

                return false;
            }

            return true;
        }

        function selectElementForPlayer(hex_tile, player_index) {
            if (isValidSelection(hex_tile, player_index)) {
                updateScoreForPlayer(player_index);

                // Mark the current hex_tile.
                players[player_index].last_selected_tile = hex_tile;
                players[player_index].last_selected_tile.style.background = players[player_index].color;
                let hex_img = hex_tile.firstElementChild;
                hex_img.style.opacity = 0.5;
                return true;
            }

            return false;
        }

        function updateScoreForPlayer(player_index) {
            let hex_tile = players[player_index].last_selected_tile;

            if (hex_tile != null) {
                // Get the image source of selected element, the names are '<path>/1fish.jpg', '<path>/2fish.jpg' ...
                // The value for updating score is the 1st character after the last '/'.
                let hex_img = hex_tile.firstElementChild;
                let score = players[player_index].score;
                score = score + parseInt(hex_img.src.charAt(hex_img.src.lastIndexOf('/') + 1));
                players[player_index].score = score;

                let scoreboard = document.querySelector('.scoreboard');
                scoreboard.childNodes[player_index].innerHTML = 'Score: ' + score;

                // Hide the previously selected element.
                hex_tile.style.visibility = 'hidden';                
            }
        }
    </script>
</html>